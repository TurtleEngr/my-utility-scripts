#!/bin/bash
# Upload local IP to asimov:~/.ssh (via CVS)
# Put "Include ~/.ssh/host.*.ip" at top of ~/.ssh/config file
set -u

if [[ $# -ne 0 && "$1" = "-h" ]]; then
    cat <<\EOF | more
Usage: my-ip [-h]

The version files in ~/.ssh will be updated, to get the IPs of the
other computers on the LAN. Put the following line in your
~/.ssh/config file:

    Include ~/.ssh/host.*.ip

This script will get the latest IP for this computer (usuallly a
laptop). If the IP is different from what is in
~/.ssh/host.$HOSTNAME.ip, the file will be updated with the new IP and
it will be checked in.

To check the IPs once an hour, put this in your crontab:

    2 6-23 * * * ~/bin/my-ip

Note: this assumes your ssh key is known by ssh-agent. See
~/bin/sshagent

EOF
    exit 1
fi

logger -p user.info "my-ip running"

# Set ssh key and get the latest IPs
. sshagent -s >/dev/null
set -u
cd ~/.ssh >/dev/null
timeout 30 cvs update
if [[ $? -ne 0 ]]; then
    logger -s -p user.crit "my-ip cvs-update-failed"
    exit 1
fi
chmod -R go= ~/.ssh/*

# Get the latest IP for this computer
cName=$(hostname -s)
cConfig=~/.ssh/host.$(hostname -s).ip

cIP=$(ifconfig | egrep 'inet 192\.168|inet 107\.220\.116' | head -n 1 | awk '{print $2}')
if [ -z "$cIP" ]; then
    logger -s -p user.warning "my-ip not-on-lan"
    exit 1
fi
echo "IP=$cIP"

# Get the last saved IP for this computer
cSavedIP=""
if [ -f $cConfig ]; then
    cSavedIP=$(grep Hostname $cConfig | awk '{print $2}')
fi
##echo "Debug: SavedIP=$cSavedIP"

if [ "$cIP" = "$cSavedIP" ]; then
    logger -s -p user.info "my-ip no-change"
    exit 0
fi

# It is different, so update it IP file
cat <<EOF >$cConfig
Host $cName $cName.lan $cIP
        Hostname $cIP
        CheckHostIP yes
        Compression yes
        IdentitiesOnly=yes
        IdentityFile ~/.ssh/id.bruceraf
        User bruce
EOF
chmod go= $cConfig

# If it is new, add it to CVS
if ! grep -q "${cConfig##*/}" CVS/Entries; then
    logger -s -p user.notice "my-ip add $cName"
    cvs add ${cConfig##*/} >/dev/null 2>&1
fi

cvs ci -m "Updated $cName"
logger -s -p user.notice "my-ip updated $cName"
exit 0
