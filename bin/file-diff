#!/usr/bin/env bash
set -u

# ========================================
# Config

# Std
export cName=file-diff
export gpVerbose=0
export gpDebug=${gpDebug:-0}
export gpTest=""
export Tmp=${Tmp:-"/var/tmp/$USER/$cName"}

# Options
export gpRmCom=0
export gpRmDate=0
export gpRmKeywords=0
export gpNewlines=0
export gpRmSpaces=0

# ========================================
# Script Functions

# --------------------------------
fUsage() {
    local pStyle="${1:-usage}"
    local tProg=""

    case $pStyle in
        short | usage)
            tProg=pod2usage
            ;;
        long | text)
            tProg=pod2text
            ;;
        html)
            tProg="pod2html --title=$cName"
            ;;
        md)
            tProg=pod2markdown
            ;;
        man)
            tProg=pod2man
            ;;
        *)
            tProg=pod2text
            ;;
    esac

    # Default to pod2text if tProg does not exist
    if ! which ${tProg%% *} >/dev/null; then
        tProg=pod2text
    fi

    cat <<EOF >$Tmp/$cName.pod
=pod

=for text ========================================

=for html <hr/>

=head1 NAME $cName

If files are the same, after removing unimportant differences, return 0.

=head1 SYNOPSIS

    $cName [Options] [-h] [-H pStyle] [-v] [-x] [-T pName]

Options:

=over 4

=item -a - Select all options, s, n, c, k, d

=item -s - rm spaces

=item -n - rm newlines

=item -c - rm comments

=item -k - rm CVS keywords

=item -d - rm dates

=back

=head1 DESCRIPTION

If files are the same, after removing unimportant differences, return 0.

The options -s, -n, -c, -k, and -d determine what is text is removed
from the files before doing a diff. If there are no options, then it
is a plain diff.

=head1 OPTIONS

=over 4

=item B<-a>

Select all options, -s, -n, -c, -k, -d

=item B<-s>

rm spaces

=item B<-n>

rm newlines

=item B<-c>

rm comments

=item B<-k>

rm CVS keywords

=item B<-d>

rm dates

=item B<-h>

Output this "long" usage help. See "-H long"

=item B<-H pStyle>

pStyle is used to select the type of help and how it is formatted.

Styles:

    short|usage - Output short usage help as text.
    long|text   - Output long usage help as text.
    man         - Output long usage help as a man page.
    html        - Output long usage help as html.
    md          - Output long usage help as markdown.

=item B<-v>

Verbose mode. Mainlye show the diff output.

=item B<-x>

List the temp files that are filtered before doing the diff.

=item B<-T pName>

Not implemented.

all - run all tests

list - list test names

=back

=for comment =head2 Globals
=for comment =head1 RETURN VALUE
=for comment =head1 ERRORS
=for comment =head1 EXAMPLES
=for comment =head1 ENVIRONMENT

gpDebug, Tmp

=for comment =head1 FILES

=head1 SEE ALSO

diff

=for comment =head1 NOTES
=for comment =head1 CAVEATS
=for comment =head1 DIAGNOSTICS
=for comment =head1 BUGS
=for comment =head1 RESTRICTIONS
=for comment =head1 AUTHOR

=head1 HISTORY

GPLv2 (c) Copyright

=cut
EOF
    # shellcheck disable=SC2002
    cat $Tmp/$cName.pod | $tProg | less
    exit 2
} # fUsage

# --------------------
fRmSp() {
    for i in 1 2; do
        sed -iE '
            s/^[[:space:]]*//
            s/[[:space:]]*$//
        ' $Tmp/file$i.tmp
    done
}

# --------------------
fRmNL() {
    for i in 1 2; do
        awk '
            /^[ \t]*$/ {
                next
            }
            { print $0 }
        ' <$Tmp/file$i.tmp >$Tmp/t.tmp
        mv $Tmp/t.tmp $Tmp/file$i.tmp
    done
}

# --------------------
fRmCom() {
    for i in 1 2; do
        sed -iE '
            s/^#.*$//
            s/[ \t]#.*$//
            s;^//.*$;;
            s;[ \t]//.*$;;
        ' $Tmp/file$i.tmp
    done
}

# --------------------
fRmCVS() {
    for i in 1 2; do
        sed -iE '
            s/\$Id: .*\$//
            s/\$Header: .*$//
            s/\$Date: .*\$//
            s/\$Revision: .*\$//
        ' $Tmp/file$i.tmp
    done
}

# --------------------
fRmDate() {
    for i in 1 2; do
        sed -iE '
            # YYYY-MM-DDD
            s/[0-9]{4}[-/][0-9]{2}[-/][0-9]{2}//g

            # MM-DD-YY, DD-MM-YYYY, mm/dd/yy...
            s/[0-9]{2}[-/][0-9]{2}[-/][0-9]{2,4}//g

            # Month DD, YYYY
            s/January [0-9]{1:2}, [0-9]{4}//g
            s/February [0-9]{1:2}, [0-9]{4}//g
            s/March [0-9]{1:2}, [0-9]{4}//g
            s/April [0-9]{1:2}, [0-9]{4}//g
            s/May [0-9]{1:2}, [0-9]{4}//g
            s/June [0-9]{1:2}, [0-9]{4}//g
            s/July [0-9]{1:2}, [0-9]{4}//g
            s/August [0-9]{1:2}, [0-9]{4}//g
            s/September [0-9]{1:2}, [0-9]{4}//g
            s/November [0-9]{1:2}, [0-9]{4}//g
            s/December [0-9]{1:2}, [0-9]{4}//g

            # Mon DD, YYYY  Mon-DD-YY  Mon/DD/YYYY
            s/Jan[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Feb[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Mar[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Apr[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/May[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Jun[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Jul[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Aug[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Sep[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Nov[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
            s/Dec[-/ ][0-9]{2}[-/, ] *[0-9]{2,4}//g
        ' $Tmp/file$i.tmp
    done
}

# ========================================
# Tests

# --------------------------------
oneTimeSetUp() {
    # When calling $cName, unset gpTest to prevent infinite loop
    gpTest=''

    return 0
} # oneTimeSetUp

# --------------------------------
oneTimeTearDown() {
    return 0
} # oneTearDown

# --------------------------------
setUp() {
    return 0
} # setUp

# --------------------------------
tearDown() {
    return 0
} # tearDown

# --------------------------------
testUsage() {
    local tResult

    #-----
    tResult=$(fUsage short 2>&1)
    assertContains "$LINENO short" "$tResult" "NAME SCRIPTNAME"

    #-----
    tResult=$(fUsage foo 2>&1)
    assertContains "$LINENO foo.1" "$tResult" "NAME SCRIPTNAME"

    #-----
    tResult=$(fUsage text 2>&1)
    assertContains "$LINENO long.1" "$tResult" "DESCRIPTION"
    assertContains "$LINENO long.2" "$tResult" "HISTORY"

    #-----
    tResult=$(fUsage man 2>&1)
    assertContains "$LINENO man.1" "$tResult" '.IX Header "DESCRIPTION"'
    assertContains "$LINENO man.2" "$tResult" '.IX Header "HISTORY"'

    #-----
    tResult=$(fUsage html 2>&1)
    assertContains "$LINENO html.1" "$tResult" '<li><a href="#DESCRIPTION">DESCRIPTION</a></li>'
    assertContains "$LINENO html.2" "$tResult" '<h1 id="HISTORY">HISTORY</h1>'
    assertContains "$LINENO html.3" "$tResult" "<title>$cName Usage</title>"

    #-----
    tResult=$(fUsage md 2>&1)
    assertContains "$LINENO md.1" "$tResult" '# DESCRIPTION'
    assertContains "$LINENO md.2" "$tResult" '# HISTORY'

    #-----
    tResult=$(fUsage int 2>&1)
    assertContains "$LINENO internal.1" "$tResult" 'Template Use'
    assertContains "$LINENO internal.2" "$tResult" 'fComSetGlobals'

    #-----
    tResult=$(fUsage int-html 2>&1)
    assertContains "$LINENO int-html.1" "$tResult" '<a href="#Template-Use">Template Use</a>'
    assertContains "$LINENO int-html.2" "$tResult" '<h3 id="fComSetGlobals">fComSetGlobals</h3>'
    assertContains "$LINENO int-html.3" "$tResult" 'Internal Doc</title>'
    assertContains "$LINENO int-html.4" "$tResult" '<h3 id="testComUsage">testComUsage</h3>'

    #-----
    tResult=$(fUsage int-md 2>&1)
    assertContains "$LINENO int-md.1" "$tResult" '## Template Use'
    assertContains "$LINENO int-md.2" "$tResult" '### fComSetGlobals'
    assertContains "$LINENO int-md.3" "$tResult" '### testComUsage'

    #-----
    tResult=$($cBin/$cName 2>&1)
    assertContains "$LINENO cmd-call" "$tResult" "Usage:"
    assertContains "$LINENO cmd-call" "$tResult" "$cName"

    #-----
    return 0
} # testUsage

# --------------------------------
testScriptFunctions() {
    local tResult

    tResult=$(fSetGlobals 2>&1)
    assertTrue "$LINENO tsf-fSetGlobals" "[ $? -eq 0 ]"

    gpHostName="foobar"
    tResult=$(fValidateHostName 2>&1)
    assertTrue "$LINENO tsf-fValidateHostName.1" "[ $? -eq 0 ]"

    gpHostName=""
    tResult=$(fValidateHostName 2>&1)
    assertContains "$LINENO tsf-fValidateHostName.2" "$tResult" "required."

    return 0
} # testScriptFunctions

# -------------------
# This should be the last defined function
fRunTests() {
    if [[ "$gpTest" = "list" ]]; then
        grep 'test.*()' $cBin/$cName | grep -v grep | sed 's/()//g'
        #        grep 'test.*()' $cBin/bash-com.test | grep -v grep | sed 's/()//g'
        exit 1
    fi
    SHUNIT_COLOR=auto
    # SHUNIT_COLOR=always
    # SHUNIT_COLOR=none
    if [[ "$gpTest" = "all" ]]; then
        gpTest=""
        # shellcheck disable=SC1091
        . /usr/local/bin/shunit2.1
        exit $?
    fi
    if [[ "$gpTest" = "com" ]]; then
        gpTest=""
        $cBin/bash-com.test
        exit $?
    fi
    # shellcheck disable=SC1091
    . /usr/local/bin/shunit2.1 -- $gpTest
    exit $?
} # fRunTests

# ========================================
# Main

# -------------------
# Init

if [[ ! -d $Tmp ]]; then
    mkdir -p $Tmp
fi
if [[ $USER = "root" ]]; then
    chown -R $SUDO_USER:$SUDO_USER $Tmp
else
    chown -R $USER:$USER $Tmp
fi
chmod ug+rwx,o= $Tmp

# -------------------
# Get Args Section
if [[ $# -eq 0 ]]; then
    fUsage usage
fi

while getopts :acdknshH:vxT:: tArg; do
    case $tArg in
        # Script arguments
        a)
            gpRmCom=1
            gpRmDate=1
            gpRmKeywords=1
            gpNewlines=1
            gpRmSpaces=1
            ;;
        c) gpRmCom=1 ;;
        d) gpRmDate=1 ;;
        k) gpRmKeywords=1 ;;
        n) gpNewlines=1 ;;
        s) gpRmSpaces=1 ;;
        # Common arguments
        h)
            fUsage long
            ;;
        H)
            fUsage $OPTARG
            ;;
        v)
            gpVerbose=1
            ;;
        x)
            gpDebug-1
            ;;
        T)
            echo "Warning: Test option is not implemented. [$LINENO]"
            fUsage usage
            gpTest="$OPTARG"
            ;;
        # Problem arguments
        :)
            echo "Error: Value required for option: -$OPTARG [$LINENO]"
            fUsage usage
            ;;
        \?)
            echo "Error: Unknown option: $OPTARG [$LINENO]"
            fUsage usage
            ;;
    esac
done
((--OPTIND))
shift $OPTIND
if [[ $# -ne 2 ]]; then
    echo "Error: two file names are required. [$LINENO]"
    fUsage usage
fi
gpFile[1]=$1
gpFile[2]=$2
shift 2

# --------------------
# Validate section

tBinary=0
for i in 1 2; do
    if [[ -d ${gpFile[$i]} ]]; then
        echo "Error: ${gpFile[$i]} is not a file [$LINENO]"
        fUsage usage
    fi
    if [[ ! -r ${gpFile[$i]} ]]; then
        echo "Error: Cannot read ${gpFile[$i]} [$LINENO]"
        fUsage usage
    fi
    if file --mime-encoding -- "$i" | grep -q binary; then
        tBinary=1
    fi
done

# --------------------
# Functional section

# If binary just use cmp, and exit
if [[ $tBinary -ne 0 ]]; then
    cmp -s ${gpFile[1]} ${gpFile[2]}
    exit $?
fi

# If not binary, apply ascii filters, then use diff
for i in 1 2; do
    cp ${gpFile[$i]} $Tmp/file$i.tmp
done

if [[ $gpRmCom -ne 0 ]]; then
    if [[ $gpVerbose -ne 0 ]]; then echo "Info: rm comments [$LINENO]"; fi
    fRmCom
fi

if [[ $gpRmKeywords -ne 0 ]]; then
    if [[ $gpVerbose -ne 0 ]]; then echo "Info: rm CVS keywords [$LINENO]"; fi
    fRmCVS
fi

if [[ $gpRmDate -ne 0 ]]; then
    if [[ $gpVerbose -ne 0 ]]; then echo "Info: rm dates [$LINENO]"; fi
    fRmDate
fi

if [[ $gpRmSpaces -ne 0 ]]; then
    if [[ $gpVerbose -ne 0 ]]; then echo "Info: rm spaces [$LINENO]"; fi
    fRmSp
fi

if [[ $gpNewlines -ne 0 ]]; then
    if [[ $gpVerbose -ne 0 ]]; then echo "Info: rm newlines [$LINENO]"; fi
    fRmNL
fi

if [[ $gpVerbose -ne 0 ]]; then
    diff $Tmp/file1.tmp $Tmp/file2.tmp
else
    diff -q $Tmp/file1.tmp $Tmp/file2.tmp >/dev/null 2>&1
fi
tStatus=$?

if [[ $gpVerbose -ne 0 ]]; then
    if [[ $tStatus -eq 0 ]]; then
        echo "Notice: Files are the same [$LINENO]"
    else
        echo "Notice: Files are different [$LINENO]"
    fi
fi

if [[ $gpDebug -ne 0 ]]; then
    echo "Debug: Files compared: [LINENO]"
    echo "$Tmp/file1.tmp"
    echo "$Tmp/file2.tmp"
fi

exit $tStatus
